<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π —Å–∏–º—É–ª—è—Ç–æ—Ä - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</title>
    
    <!-- Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- –°—Ç–∏–ª–∏ -->
    <link rel="stylesheet" href="css/core/variables.css">
    <link rel="stylesheet" href="css/core/reset.css">
    <link rel="stylesheet" href="css/core/base.css">
    <link rel="stylesheet" href="css/components/buttons.css">
    <link rel="stylesheet" href="css/components/cards.css">
    <link rel="stylesheet" href="css/components/notifications.css">
    <link rel="stylesheet" href="css/layouts/main-menu.css">
    
    <!-- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∑–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤ -->
    <link rel="preload" href="js/core/game-engine.js" as="script">
    <link rel="preload" href="js/core/navigation.js" as="script">
</head>
<body>
    <div id="app">
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å -->
        <div id="main-content">
            <div class="main-menu-container">
                <div class="menu-header">
                    <div class="game-logo">
                        <h1 class="game-title">üí∞ –≠–∫–æ–Ω–æ–º–∏—á–µ—Å–∫–∏–π –°–∏–º—É–ª—è—Ç–æ—Ä</h1>
                        <p class="game-subtitle">–°—Ç–∞–Ω—å –º–∞—Å—Ç–µ—Ä–æ–º —Ç–æ—Ä–≥–æ–≤–ª–∏!</p>
                    </div>
                    
                    <!-- –°—Ç–∞—Ç—É—Å –∏–≥—Ä–æ–∫–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ) -->
                    <div class="player-status" id="playerStatus" style="display: none;">
                        <div class="status-info">
                            <span class="level-badge" id="playerLevel">–£—Ä. 1</span>
                            <span class="money-amount" id="playerMoney">100 ‚ÇΩ</span>
                        </div>
                    </div>
                </div>

                <div class="menu-actions">
                    <button class="btn-primary btn-large" data-navigation="city_map" data-action="start-game">
                        <span class="btn-icon">üéÆ</span>
                        <span class="btn-text">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</span>
                    </button>

                    <button class="btn-secondary btn-large" data-navigation="skills" data-action="skills">
                        <span class="btn-icon">üéØ</span>
                        <span class="btn-text">–£–º–µ–Ω–∏—è</span>
                    </button>

                    <button class="btn-secondary btn-large" data-navigation="character" data-action="character">
                        <span class="btn-icon">üë§</span>
                        <span class="btn-text">–ü–µ—Ä—Å–æ–Ω–∞–∂</span>
                    </button>

                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ -->
                    <div class="menu-options">
                        <button class="btn-tertiary" data-action="settings">
                            <span class="btn-icon">‚öôÔ∏è</span>
                            <span class="btn-text">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                        </button>

                        <button class="btn-tertiary" data-action="load-game" id="loadGameBtn" style="display: none;">
                            <span class="btn-icon">üíæ</span>
                            <span class="btn-text">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É</span>
                        </button>

                        <button class="btn-tertiary" data-action="achievements">
                            <span class="btn-icon">üèÜ</span>
                            <span class="btn-text">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</span>
                        </button>
                    </div>
                </div>

                <!-- –ë—ã—Å—Ç—Ä–æ–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ (–µ—Å–ª–∏ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–∞—è —Å–µ—Å—Å–∏—è) -->
                <div class="quick-resume" id="quickResume" style="display: none;">
                    <div class="resume-card">
                        <h3>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É</h3>
                        <p>–í–æ–∑–≤—Ä–∞—â–∞–π—Ç–µ—Å—å –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å–µ—Å—Å–∏–∏</p>
                        <button class="btn-continue" data-action="resume-game">
                            <span class="btn-icon">‚Üª</span>
                            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
                        </button>
                    </div>
                </div>

                <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–≥—Ä—ã -->
                <div class="game-stats" id="gameStats">
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="totalPlayTime">0</span>
                            <span class="stat-label">–í—Ä–µ–º—è –∏–≥—Ä—ã</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="battlesFought">0</span>
                            <span class="stat-label">–°–¥–µ–ª–∫–∏</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="moneyEarned">0</span>
                            <span class="stat-label">–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
        <div id="notification-container" class="notification-container"></div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="navigation-loader" class="navigation-loader" style="display: none;">
            <div class="loader-overlay">
                <div class="loader-spinner"></div>
                <div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>

        <!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
        <div id="modal-container" class="modal-container"></div>
    </div>

    <!-- JavaScript –º–æ–¥—É–ª–∏ -->
    <script src="js/utils/helpers.js"></script>
    <script src="js/utils/storage.js"></script>
    
    <!-- –î–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã -->
    <script src="js/data/character.js"></script>
    <script src="js/data/opponents-data.js"></script>
    <script src="js/data/skills-data.js"></script>
    <script src="js/data/items-data.js"></script>
    
    <!-- –û—Å–Ω–æ–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã -->
    <script src="js/core/navigation.js"></script>
    <script src="js/core/map-system.js"></script>
    <script src="js/core/combat-system.js"></script>
    <script src="js/core/game-engine.js"></script>
    
    <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
        window.addEventListener('error', function(event) {
            console.error('–ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞:', event.error);
            if (window.helpers) {
                window.helpers.showNotification('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏', 'error');
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö —Å–∏—Å—Ç–µ–º
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π
                if (!window.helpers || !window.storageSystem) {
                    throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Å–Ω–æ–≤–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã');
                }

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–≤–æ–≥–æ –¥–≤–∏–∂–∫–∞
                if (window.gameEngine) {
                    await window.gameEngine.init();
                }

                // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
                await checkExistingSave();
                
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
                updateMainMenu();

                console.log('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ');

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:', error);
                showFatalError(error);
            }
        });

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–π
        async function checkExistingSave() {
            if (window.storageSystem) {
                const saveInfo = await window.storageSystem.getSaveInfo();
                const loadBtn = document.getElementById('loadGameBtn');
                const quickResume = document.getElementById('quickResume');
                
                if (saveInfo.saves.auto.exists) {
                    loadBtn.style.display = 'block';
                    quickResume.style.display = 'block';
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
        function updateMainMenu() {
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä–æ–∫–∞
            updatePlayerStatus();
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            updateGameStats();
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
            setupEventListeners();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏–≥—Ä–æ–∫–∞
        function updatePlayerStatus() {
            if (window.characterSystem) {
                const character = window.characterSystem.getCharacter();
                const playerStatus = document.getElementById('playerStatus');
                const playerLevel = document.getElementById('playerLevel');
                const playerMoney = document.getElementById('playerMoney');
                
                if (character && character.level > 1) {
                    playerLevel.textContent = `–£—Ä. ${character.level}`;
                    playerMoney.textContent = `${window.helpers.formatNumber(character.money)} ‚ÇΩ`;
                    playerStatus.style.display = 'block';
                }
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä—ã
        function updateGameStats() {
            if (window.gameEngine) {
                const stats = window.gameEngine.statistics;
                const totalPlayTime = document.getElementById('totalPlayTime');
                const battlesFought = document.getElementById('battlesFought');
                const moneyEarned = document.getElementById('moneyEarned');
                
                if (stats.totalPlayTime > 0) {
                    totalPlayTime.textContent = window.helpers.formatDuration(stats.totalPlayTime);
                    battlesFought.textContent = window.helpers.formatNumber(stats.battlesFought);
                    moneyEarned.textContent = window.helpers.formatNumber(stats.moneyEarned);
                }
            }
        }

        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π
        function setupEventListeners() {
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
            document.addEventListener('click', function(event) {
                const button = event.target.closest('button[data-action]');
                if (button) {
                    const action = button.getAttribute('data-action');
                    handleMenuAction(action);
                }
            });

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Å—ã–ª–æ–∫
            document.addEventListener('click', function(event) {
                const link = event.target.closest('[data-navigation]');
                if (link && window.navigation) {
                    event.preventDefault();
                    const route = link.getAttribute('data-navigation');
                    window.navigation.navigateTo(route);
                }
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –º–µ–Ω—é
        function handleMenuAction(action) {
            switch (action) {
                case 'start-game':
                    startNewGame();
                    break;
                case 'load-game':
                    loadGame();
                    break;
                case 'resume-game':
                    resumeGame();
                    break;
                case 'settings':
                    showSettings();
                    break;
                case 'achievements':
                    showAchievements();
                    break;
            }
        }

        // –ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É
        function startNewGame() {
            if (window.characterSystem && window.characterSystem.getCharacter().level > 1) {
                showConfirmationModal(
                    '–ù–∞—á–∞—Ç—å –Ω–æ–≤—É—é –∏–≥—Ä—É?',
                    '–¢–µ–∫—É—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.',
                    () => {
                        window.characterSystem.resetCharacter();
                        window.gameEngine.resetProgress();
                        window.navigation.navigateTo('city_map');
                    }
                );
            } else {
                window.navigation.navigateTo('city_map');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–≥—Ä—É
        async function loadGame() {
            if (window.storageSystem) {
                const result = await window.storageSystem.loadGame();
                if (result.success) {
                    window.helpers.showNotification('–ò–≥—Ä–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'success');
                    updateMainMenu();
                } else {
                    window.helpers.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏', 'error');
                }
            }
        }

        // –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏–≥—Ä—É
        function resumeGame() {
            if (window.mapSystem && window.mapSystem.getCurrentLocation()) {
                const location = window.mapSystem.getCurrentLocation();
                window.navigation.navigateTo('game', {
                    location: location.id,
                    map: window.mapSystem.getCurrentMap().id
                });
            } else {
                window.navigation.navigateTo('city_map');
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
        function showSettings() {
            // –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            window.helpers.showNotification('–†–∞–∑–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è
        function showAchievements() {
            // –í—Ä–µ–º–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - –±—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            window.helpers.showNotification('–†–∞–∑–¥–µ–ª –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ', 'info');
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function showConfirmationModal(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="modal-content">
                    <h3>${title}</h3>
                    <p>${message}</p>
                    <div class="modal-actions">
                        <button class="btn-secondary" data-action="cancel">–û—Ç–º–µ–Ω–∞</button>
                        <button class="btn-primary" data-action="confirm">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').appendChild(modal);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            modal.querySelector('[data-action="cancel"]').onclick = () => modal.remove();
            modal.querySelector('[data-action="confirm"]').onclick = () => {
                modal.remove();
                onConfirm();
            };
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–∞—Ç–∞–ª—å–Ω—É—é –æ—à–∏–±–∫—É
        function showFatalError(error) {
            const errorHtml = `
                <div class="fatal-error">
                    <div class="error-icon">üí•</div>
                    <h2>–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞</h2>
                    <p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</p>
                    <p><small>${error.message}</small></p>
                    <button onclick="location.reload()" class="btn-primary">–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
            `;
            
            document.getElementById('main-content').innerHTML = errorHtml;
        }

        // –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Web App
        if (window.Telegram && window.Telegram.WebApp) {
            const tg = window.Telegram.WebApp;
            
            // –†–∞—Å—à–∏—Ä–∏—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            tg.expand();
            
            // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥
            tg.BackButton.onClick(() => {
                if (window.navigation) {
                    window.navigation.goBack();
                }
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –Ω–∞–∑–∞–¥ –µ—Å–ª–∏ –Ω–µ –Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            tg.BackButton.show();
        }
    </script>
</body>
</html>
